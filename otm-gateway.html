<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>OTM Gateway API Specification</title>
    <script
     src='https://www.w3.org/Tools/respec/respec-w3c'
     class='remove'></script>
    <script class='remove'>
      var respecConfig = {
        specStatus: "base",
        editors: [{
          name: "Tom Johnson",
          company: "University of California, Santa Barbara Library",
          companyURL: "https://www.library.ucsb.edu/"
        },{
          name: "Sibyl Schaefer",
          company: "University of California, San Diego",
          companyURL: "https://ucsd.edu"
        }],
        gitHub: "ucsdlib/otm-specs",
        shortName: "otm-gateway-api",
        wg: "One to Many Working Group",
        wgURI: "https://wiki.duraspace.org/display/OTM",
        edDraftURI: "https://github.com/ucsdlib/otm-specs/blob/master/otm-gateway.html",
        overrideCopyright: "<p class='copyright'>This document is licensed under a <a class='subfoot' href='https://creativecommons.org/licenses/by/4.0/' rel='license'>Creative Commons Attribution 4.0 License</a>.</p>",
        maxTocLevel: 3
      };
    </script>
    <link rel="stylesheet" href="otm-styles.css">
  </head>
  <body>
    <section id='abstract'>
      <p>
        The One To Many (OTM) Gateway API Specification is one of two APIs used to support communication between digital
        content repository systems (Repository) and distributed digital preservation systems (DDP). These APIs work in tandem
        to allow content captured in Repository systems to be copied to DDP systems for preservation.
      </p>
      <p>
        The preservation Gateway functions as an aggregating cache for preservation requests originating with a repository
        and destined for a DDP via the  Bridge. This allows repositories to synchronously send content preservation in an
        asynchronous deep archive.
      </p>
    </section>

    <section>
      <h2>Status of This Document</h2>
      <p>This document is a draft of a specification, created as part of the One to Many grant, funded by the Andrew W.
      Mellon Foundation.</p>
    </section>

    <section id="conformance">
    </section>

    <section>
      <h2>Gateway API</h2>

      <section>
        <h3>Repository API</h3>
        <section>
          <h4><dfn>Gateway Service Description</dfn></h4>
          <p>Provides a description of this Gateway, including the API version, and the available preservation providers.</p>
          <ul>
            <li>Request Type: <code>GET</code></li>
            <li>Request Path: <code>/</code></li>
            <li>Response Body: <code>JSON</code>
              <ul>
                <li><code>gateway-version</code>: The current version of the Gateway API.</li>
                <li><code>providers</code>: The preservation providers available through this Gateway.
                  <ul>
                    <li><code>name</code>: The name of the preservation provider; e.g. "chronopolis". This name MUST be unique in the context of this gateway. Gateways SHOULD NOT change the names of preservation providers.</li>
                  </ul>
                </li>

              </ul>
            </li>
            <li>Response Code: <code>200</code> (on success)</li>
            <pre class="example" title="Gateway Service Description JSON">
              {
                "gateway-version" : "0.1.0",
                "providers" : [{
                  "name": "ddp1_name"
                 },
                {
                  "name": "ddp2_name"
                }]
              }
            </pre>
          </ul>
        </section>

        <section>
          <h4><dfn>Deposit Object</dfn></h4>
          <p>Creates or updates a Gateway Object for preservation of an Object from the repository.</p>
          <ul>
            <li>Request Type: <code>PUT</code></li>
            <li>Request Path: <code>/{object-id}</code></li>
            <li>Request Headers:
              <ul>
                <li><code>Content-Type</code>: Media type of the object to be deposited</li>
                <li><code>Content-Length</code>: Size in bytes of the object to be deposited</li>
                <li><code>x-otm-preservation-provider</code>: the name of preservation systems targeted for this deposit.</li>
              </ul>
            </li>
            <li>Request Body: Compressed Bag</li>
            <li>Response Code: <code>200</code> (on success)</li>
            <li>Response Headers:
              <ul>
                <li><code>ETag</code>: Entity tag for the deposited object.</li>
              </ul>
            </li>
            <pre class="example" title="Deposit Object Request">
              PUT /af48c3d HTTP/1.1
              Host: preservation-gateway.institution.edu
              Date: Tue, 02 Jul 2019 20:15:00 GMT
              Content-Type: application/zip
              Content-Length: 493285
              Content-MD5: 4efcb3d98ce0fabfd585eb6c4332859

              [493285 bytes of object data]
            </pre>
            <pre class="example" title="Deposit Object Response">
              HTTP/1.1 200 OK
              Date: Tue, 02 Jul 2019 20:15:00 GMT
              ETag: "4efcb3d98ce0fabfd585eb6c4332859"
              Content-Length: 0
              Server: OTM Preservation Gateway
            </pre>
            <ul class="note">
              <li>The ETag contents MAY be an MD5 checksum of the request body. However, clients SHOULD NOT attempt to use the ETag to verify fixity.</li>
            </ul>
        </section>

        <section>
          <h4><dfn>Get Object Audit</dfn></h4>
          <p></p>
          <ul>
            <li>Request Type: <code>GET</code></li>
            <li>Request Path: <code>/{object-id}/audit</code></li>
            <li>Response Body: <code>JSON</code></li>
            <li>Response Code: <code>200</code> (on success)</li>
            <pre class="example" title="Object Audit JSON">
              {
              }
            </pre>
          </ul>
        </section>

        <section>
          <h4><dfn>Purge Object</dfn></h4>
          <p></p>
          <ul>
            <li>Request Type: <code>DELETE</code></li>
            <li>Request Path: <code>/{object-id}</code></li>
            <li>Response Code: <code>204</code> (on success)</li>
          </ul>
          <pre class="example" title="Purge Object Request">
            DELETE /af48c3d HTTP/1.1
            Host: preservation-gateway.institution.edu
            Date: Tue, 02 Jul 2019 20:25:00 GMT
            Content-Type: text/plain
          </pre>
          <pre class="example" title="Purge Object Response">
            HTTP/1.1 204 NoContent
            Date: Tue, 02 Jul 2019 20:25:00 GMT
            Content-Length: 0
            Server: OTM Preservation Gateway
          </pre>
        </section>

        <section>
          <h4><dfn>Initiate Restore</dfn></h4>
          <p>Request restore of an Object and all its contents for later retrieval</p>
          <ul>
            <li>Request Type: <code>POST</code></li>
            <li>Request Path: <code>/{object-id}?restore</code></li>
            <li>Response Code:
              <ul>
                <li><code>202</code> (if the object)</li>
                <li><code>200</code> (if the object is restored and available for retrieval)</li>
                <li><code>409</code> (if there is a restore already in progress)</li>
             </ul>
            </li>
          </ul>
          <pre class="example" title="Restore Object Request">
            POST /af48c3d?restore HTTP/1.1
            Host: preservation-gateway.institution.edu
            Date: Tue, 02 Jul 2019 20:35:00 GMT
            Content-Length: 0
          </pre>
          <pre class="example" title="Restore Object Response">
            HTTP/1.1 202 Accepted
            Date: Tue, 02 Jul 2019 20:35:00 GMT
            Content-Length: 0
            Server: OTM Preservation Gateway
          </pre>
          <pre class="example" title="Restore Object Response for an object that is available">
            HTTP/1.1 200 OK
            Date: Tue, 02 Jul 2019 20:35:00 GMT
            Content-Length: 0
            Server: OTM Preservation Gateway
          </pre>
          <pre class="example" title="Restore Object Response when a restore is already in progress and a new one will not be created">
            HTTP/1.1 409 Conflict
            Date: Tue, 02 Jul 2019 20:35:00 GMT
            Content-Type: application/xml
            Server: OTM Preservation Gateway

            <?xml version="1.0" encoding="UTF-8"?>
            <Error>
              <Code>RestoreAlreadyInProgress</Code>
              <Message>Object restore is already in progress.</Message>
              <Resource>/af48c3d</Resource>
            </Error>
          </pre>
        </section>

        <section>
          <h4><dfn>Retrieve Object</dfn></h4>
          <p></p>
          <ul>
            <li>Request Type: <code>GET</code></li>
            <li>Request Path: <code>/{object-id}</code></li>
            <li>Request Headers:
              <ul>
                <li><code>If-Match</code></li>
                <li><code>If-None-Match</code></li>
                <li><code>Accept</code></li>
              </ul>
            </li>
            <li>Response Code:
              <ul>
                <li><code>200</code> (on success)</li>
                <li><code>403</code> (when attempting to access an unavailable preserved object; i.e. one that has
                  not been restored)</li>
                <li><code>412</code></li>
              </ul>
            </li>
            <li>Response Headers:
              <ul>
                <li><code>Content-Type</code></li>
                <li><code>ETag</code></li>
              </ul>
            </li>
          </ul>
          <pre class="example" title="Retrieve Object Request">
            GET /af48c3d HTTP/1.1
            Host: preservation-gateway.institution.edu
            Date: Tue, 02 Jul 2019 20:45:00 GMT
            Content-Length: 0
          </pre>
          <pre class="example" title="Retrieve Object Response">
            HTTP/1.1 200 OK
            Date: Tue, 02 Jul 2019 20:45:00 GMT
            ETag: "4efcb3d98ce0fabfd585eb6c4332859"
            Content-Length: 493285
            Content-Type: application/zip
            Server: OTM Preservation Gateway

            [493285 bytes of object data]
          </pre>
          <pre class="example" title="Retrieve Object Response for Unavailable Object">
            HTTP/1.1 403 Forbidden
            Date: Tue, 02 Jul 2019 20:45:00 GMT
            ETag: "4efcb3d98ce0fabfd585eb6c4332859"
            Content-Type: application/xml
            Server: OTM Preservation Gateway

            <?xml version="1.0" encoding="UTF-8"?>
            <Error>
              <Code>InvalidObjectState</Code>
              <Message>The Object is not available </Message>
              <Resource>/af48c3d</Resource>
            </Error>
          </pre>
        </section>
      </section>

      <section>
        <h3>Bridge API</h3>
        <section>
          <h4><dfn>Transfer File</dfn></h4>
          <p>Transfer a cached file. This endpoint allows a Bridge to pull content for storage in a preservation service.</p>
          <ul>
            <li>Request Type: <code>GET</code></li>
            <li>Request Path: <code>/{object-id}/{fileName}</code></li>
            <li>Request Headers:
              <ul>
                <li><code>If-Match</code></li>
              </ul>
            </li>
            <li>Response Code:
              <ul>
                <li><code>200</code> (on success)</li>
                <li><code>404</code> (if the file is not present)</li>
                <li><code>412</code> (if the requested file does not match the <code>If-Match</code> checksum.</li>
              </ul>
            </li>
            <li>Response Headers:
              <ul>
                <li><code>Content-Type</code></li>
                <li><code>ETag</code></li>
              </ul>
            </li>
          </ul>
        </section>
     </section>
    </section>
  </body>
</html>
